version: "3.6"

#Liste des servies
services:
  #Le service GitLAb
  gitlab:
    image: gitlab/gitlab-ce
    hostname: 'gitlab.lugar.com'
    ports:
      - "443:443"
      - "80:80"
      - "22"
    container_name: gitlab
    volumes:
      - ./gitlab_data/data:/var/opt/gitlab
      - ./gitlab_data/log:/var/log/gitlab
      - ./gitlab_data/config:/etc/gitlab

    env_file:
      - .env
    networks:
      net_backend:
        ipv4_address: 172.21.0.2
        aliases:
          - gitlab
    restart: unless-stopped

  mysql-server:
    image: mysql
    command:
      - mysqld
      - --character-set-server=utf8
      - --collation-server=utf8_bin
      - --default-authentication-plugin=mysql_native_password
    #   - --require-secure-transport
    #   - --ssl-ca=/run/secrets/root-ca.pem
    #   - --ssl-cert=/run/secrets/server-cert.pem
    #   - --ssl-key=/run/secrets/server-key.pem
    volumes:
      - "./mysql_data_gitlab/var/lib/mysql:/var/lib/mysql:rw"
    env_file:
      - .env_mysql
    container_name: mysql-server-4
    #secrets:
    #   - server-key.pem
    #   - server-cert.pem
    #   - root-ca.pem
    #  stop_grace_period: 1m
    networks:
      net_backend:
        ipv4_address: 172.21.0.16
        aliases:
          - mysql-server-4
    tty: true
    #Cette ligne permet de r√©soudre le probleme de mbind: Operation not permitted
    security_opt:
      - seccomp:unconfined
    restart: unless-stopped

networks:
  net_backend:
    external:
      name: lugar_net_backend